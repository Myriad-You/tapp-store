<!-- Weather Plus Widget 4x2 - è¯¦ç»†å¤©æ°” -->
<div class="weather-widget weather-4x2" id="weather-widget">
  <!-- åŠ¨æ€èƒŒæ™¯ -->
  <div class="weather-glow" id="weather-glow"></div>
  <div class="weather-orb weather-orb-1" id="weather-orb-1"></div>
  <div class="weather-orb weather-orb-2" id="weather-orb-2"></div>
  <div class="weather-glass-bg"></div>
  
  <!-- å†…å®¹ -->
  <div class="weather-content" id="weather-content">
    <!-- åŠ è½½çŠ¶æ€ -->
    <div class="weather-loading" id="loading-state">
      <div class="weather-spinner"></div>
      <div class="weather-loading-text">è·å–å¤©æ°”...</div>
    </div>
  </div>
  
  <!-- è¾¹æ¡†æ•ˆæœ -->
  <div class="weather-border-effect"></div>
</div>

<script>
(async function() {
  const widget = document.getElementById('weather-widget');
  const content = document.getElementById('weather-content');
  const glow = document.getElementById('weather-glow');
  const orb1 = document.getElementById('weather-orb-1');
  const orb2 = document.getElementById('weather-orb-2');
  
  // ç­‰å¾…ä¸»è„šæœ¬åŠ è½½
  await new Promise(resolve => {
    if (window.WeatherPlus) return resolve();
    const check = setInterval(() => {
      if (window.WeatherPlus) {
        clearInterval(check);
        resolve();
      }
    }, 100);
    setTimeout(() => {
      clearInterval(check);
      resolve();
    }, 5000);
  });
  
  const WP = window.WeatherPlus;
  
  // è·å–è¯­è¨€
  let locale = 'zh-CN';
  try {
    locale = await Tapp.ui.getLocale() || 'zh-CN';
  } catch (e) {}
  
  // æ¸²æŸ“é”™è¯¯çŠ¶æ€
  function renderError(message) {
    content.innerHTML = `
      <div class="weather-error weather-fade-in">
        <div class="weather-error-icon">âš ï¸</div>
        <div class="weather-error-text">${message || 'è·å–å¤©æ°”å¤±è´¥'}</div>
        <button class="weather-retry-btn" onclick="location.reload()">é‡è¯•</button>
      </div>
    `;
  }
  
  // æ¸²æŸ“å¤©æ°”æ•°æ®
  function renderWeather(data, settings) {
    const units = settings?.units || 'celsius';
    const showAqi = settings?.showAqi !== false;
    const animEnabled = settings?.animationEnabled !== false;
    
    // è®¾ç½®èƒŒæ™¯è‰²
    const color = data.color || '#3b82f6';
    glow.style.background = `linear-gradient(135deg, ${color}, transparent 60%)`;
    orb1.style.background = `linear-gradient(180deg, ${color}, transparent)`;
    orb2.style.background = color;
    
    // æ„å»ºå…ƒä¿¡æ¯
    let metaHtml = '<div class="weather-meta">';
    if (data.humidity !== undefined) {
      metaHtml += `<div class="weather-meta-item"><span>ğŸ’§</span><span>${data.humidity}%</span></div>`;
    }
    if (data.windSpeed !== undefined) {
      metaHtml += `<div class="weather-meta-item"><span>ğŸƒ</span><span>${Math.round(data.windSpeed)}km/h</span></div>`;
    }
    if (showAqi && data.aqi !== undefined && data.aqiInfo) {
      metaHtml += `<div class="weather-meta-item"><span>${data.aqiInfo.icon}</span><span style="color:${data.aqiInfo.color}">AQI ${data.aqi}</span></div>`;
    }
    metaHtml += '</div>';
    
    // æ„å»ºé¢„æŠ¥åˆ—è¡¨
    let forecastHtml = '<div class="weather-forecast">';
    if (data.forecast && data.forecast.length > 0) {
      data.forecast.slice(0, 3).forEach((day, i) => {
        forecastHtml += `
          <div class="forecast-item weather-fade-in" style="animation-delay: ${0.1 * (i + 1)}s">
            <div class="forecast-day">${WP.formatWeekday(day.date, locale)}</div>
            <div class="forecast-icon">${day.icon}</div>
            <div class="forecast-temps">
              <span class="forecast-temp-high">${WP.formatTempValue(day.maxTemp, units)}Â°</span>
              <span class="forecast-temp-low">${WP.formatTempValue(day.minTemp, units)}Â°</span>
            </div>
          </div>
        `;
      });
    } else {
      forecastHtml += '<div class="weather-loading-text" style="text-align:center;padding:12px">æš‚æ— é¢„æŠ¥</div>';
    }
    forecastHtml += '</div>';
    
    content.innerHTML = `
      <div class="weather-main weather-fade-in">
        <div class="weather-city">${data.city}</div>
        <div class="weather-header">
          <div class="weather-icon" style="${animEnabled ? '' : 'animation:none'}">${data.icon}</div>
          <div class="weather-info">
            <div class="weather-temp">${WP.formatTemp(data.temperature, units)}</div>
            <div class="weather-text">${data.text}${data.feelsLike !== undefined ? ` Â· ä½“æ„Ÿ ${WP.formatTempValue(data.feelsLike, units)}Â°` : ''}</div>
          </div>
        </div>
        ${metaHtml}
      </div>
      ${forecastHtml}
    `;
  }
  
  // åŠ è½½å¤©æ°”
  try {
    if (!WP) {
      renderError('åŠ è½½å¤±è´¥');
      return;
    }
    
    const result = await WP.getFullWeatherInfo();
    
    if (result.error) {
      renderError(result.message);
      return;
    }
    
    renderWeather(result.data, result.settings);
  } catch (error) {
    console.error('[Weather 4x2] Error:', error);
    renderError('è·å–å¤±è´¥');
  }
})();
</script>
