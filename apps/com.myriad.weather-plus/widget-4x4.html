<!-- Weather Plus Widget 4x4 - å®Œæ•´å¤©æ°”é¢„æŠ¥ -->
<div class="weather-widget weather-4x4" id="weather-widget">
  <!-- åŠ¨æ€èƒŒæ™¯ -->
  <div class="weather-glow" id="weather-glow"></div>
  <div class="weather-orb weather-orb-1" id="weather-orb-1"></div>
  <div class="weather-orb weather-orb-2" id="weather-orb-2"></div>
  <div class="weather-glass-bg"></div>
  
  <!-- å†…å®¹ -->
  <div class="weather-content" id="weather-content">
    <!-- åŠ è½½çŠ¶æ€ -->
    <div class="weather-loading" id="loading-state">
      <div class="weather-spinner"></div>
      <div class="weather-loading-text">è·å–å¤©æ°”...</div>
    </div>
  </div>
  
  <!-- è¾¹æ¡†æ•ˆæœ -->
  <div class="weather-border-effect"></div>
</div>

<script>
(async function() {
  const widget = document.getElementById('weather-widget');
  const content = document.getElementById('weather-content');
  const glow = document.getElementById('weather-glow');
  const orb1 = document.getElementById('weather-orb-1');
  const orb2 = document.getElementById('weather-orb-2');
  
  // ç­‰å¾…ä¸»è„šæœ¬åŠ è½½
  await new Promise(resolve => {
    if (window.WeatherPlus) return resolve();
    const check = setInterval(() => {
      if (window.WeatherPlus) {
        clearInterval(check);
        resolve();
      }
    }, 100);
    setTimeout(() => {
      clearInterval(check);
      resolve();
    }, 5000);
  });
  
  const WP = window.WeatherPlus;
  
  // è·å–è¯­è¨€
  let locale = 'zh-CN';
  try {
    locale = await Tapp.ui.getLocale() || 'zh-CN';
  } catch (e) {}
  
  // æ¸²æŸ“é”™è¯¯çŠ¶æ€
  function renderError(message) {
    content.innerHTML = `
      <div class="weather-error weather-fade-in">
        <div class="weather-error-icon">âš ï¸</div>
        <div class="weather-error-text">${message || 'è·å–å¤©æ°”å¤±è´¥'}</div>
        <button class="weather-retry-btn" onclick="location.reload()">é‡è¯•</button>
      </div>
    `;
  }
  
  // æ¸²æŸ“å¤©æ°”æ•°æ®
  function renderWeather(data, settings) {
    const units = settings?.units || 'celsius';
    const showAqi = settings?.showAqi !== false;
    const animEnabled = settings?.animationEnabled !== false;
    
    // è®¾ç½®èƒŒæ™¯è‰²
    const color = data.color || '#3b82f6';
    glow.style.background = `linear-gradient(135deg, ${color}, transparent 60%)`;
    orb1.style.background = `linear-gradient(180deg, ${color}, transparent)`;
    orb2.style.background = color;
    
    // æ„å»ºè¯¦æƒ…å¡ç‰‡
    let detailsHtml = '<div class="weather-details-grid">';
    
    // æ¹¿åº¦
    if (data.humidity !== undefined) {
      detailsHtml += `
        <div class="detail-card weather-fade-in" style="animation-delay: 0.15s">
          <div class="detail-label">æ¹¿åº¦</div>
          <div class="detail-value">
            <span class="detail-icon">ğŸ’§</span>
            <span>${data.humidity}%</span>
          </div>
        </div>
      `;
    }
    
    // é£é€Ÿ
    if (data.windSpeed !== undefined) {
      detailsHtml += `
        <div class="detail-card weather-fade-in" style="animation-delay: 0.2s">
          <div class="detail-label">é£é€Ÿ</div>
          <div class="detail-value">
            <span class="detail-icon">ğŸƒ</span>
            <span>${Math.round(data.windSpeed)} km/h</span>
          </div>
        </div>
      `;
    }
    
    // ä½“æ„Ÿæ¸©åº¦
    if (data.feelsLike !== undefined) {
      detailsHtml += `
        <div class="detail-card weather-fade-in" style="animation-delay: 0.25s">
          <div class="detail-label">ä½“æ„Ÿæ¸©åº¦</div>
          <div class="detail-value">
            <span class="detail-icon">ğŸŒ¡ï¸</span>
            <span>${WP.formatTemp(data.feelsLike, units)}</span>
          </div>
        </div>
      `;
    }
    
    // ç©ºæ°”è´¨é‡
    if (showAqi && data.aqi !== undefined && data.aqiInfo) {
      detailsHtml += `
        <div class="detail-card weather-fade-in" style="animation-delay: 0.3s">
          <div class="detail-label">ç©ºæ°”è´¨é‡</div>
          <div class="detail-value">
            <span class="aqi-badge" style="background: ${data.aqiInfo.color}20; color: ${data.aqiInfo.color}">
              ${data.aqiInfo.icon} ${data.aqiInfo.text}
            </span>
          </div>
        </div>
      `;
    }
    
    detailsHtml += '</div>';
    
    // æ„å»ºé¢„æŠ¥åˆ—è¡¨
    let forecastHtml = `
      <div class="weather-forecast">
        <div class="forecast-title">æœªæ¥å¤©æ°”</div>
        <div class="forecast-list">
    `;
    
    if (data.forecast && data.forecast.length > 0) {
      data.forecast.forEach((day, i) => {
        forecastHtml += `
          <div class="forecast-item weather-fade-in" style="animation-delay: ${0.35 + 0.05 * i}s">
            <div class="forecast-day">${WP.formatWeekday(day.date, locale)}</div>
            <div class="forecast-icon">${day.icon}</div>
            <div class="forecast-text">${day.text}</div>
            <div class="forecast-temps">
              <span class="forecast-temp-high">${WP.formatTempValue(day.maxTemp, units)}Â°</span>
              <span class="forecast-temp-low">${WP.formatTempValue(day.minTemp, units)}Â°</span>
            </div>
          </div>
        `;
      });
    } else {
      forecastHtml += '<div class="weather-loading-text" style="text-align:center;padding:24px">æš‚æ— é¢„æŠ¥æ•°æ®</div>';
    }
    
    forecastHtml += '</div></div>';
    
    content.innerHTML = `
      <div class="weather-top weather-fade-in">
        <div class="weather-current">
          <div class="weather-city">ğŸ“ ${data.city}</div>
          <div class="weather-main-row">
            <div class="weather-icon" style="${animEnabled ? '' : 'animation:none'}">${data.icon}</div>
            <div>
              <div class="weather-temp">${WP.formatTemp(data.temperature, units)}</div>
              <div class="weather-text">${data.text}</div>
              ${data.feelsLike !== undefined ? `<div class="weather-feels">ä½“æ„Ÿ ${WP.formatTemp(data.feelsLike, units)}</div>` : ''}
            </div>
          </div>
          ${detailsHtml}
        </div>
      </div>
      ${forecastHtml}
    `;
  }
  
  // åŠ è½½å¤©æ°”
  try {
    if (!WP) {
      renderError('åŠ è½½å¤±è´¥');
      return;
    }
    
    const result = await WP.getFullWeatherInfo();
    
    if (result.error) {
      renderError(result.message);
      return;
    }
    
    renderWeather(result.data, result.settings);
  } catch (error) {
    console.error('[Weather 4x4] Error:', error);
    renderError('è·å–å¤±è´¥');
  }
})();
</script>
